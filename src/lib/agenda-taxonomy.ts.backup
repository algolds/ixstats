// src/lib/agenda-taxonomy.ts
/**
 * Hierarchical Agenda Item Taxonomy
 *
 * This system provides a structured way to select meeting agenda items that map
 * to game data structures. Items are organized in a drill-down fashion:
 * Level 1: Broad categories (Policy, Budget, Infrastructure, etc.)
 * Level 2: Specific subcategories
 * Level 3: Detailed topics
 * Level 4+: Specific items that map to actual game data
 */

export interface AgendaItemTemplate {
  id: string;
  label: string;
  description: string;
  category: string; // Maps to MeetingAgendaItem.category
  keywords: string[]; // For search/filter
  tags: string[]; // Maps to MeetingAgendaItem.tags
  relatedMetrics?: string[]; // Country metrics this affects
  decisionType?: string; // Maps to MeetingDecision.decisionType
  dataMapping?: {
    // Maps to specific database models/fields
    model: string; // e.g., "GovernmentDepartment", "BudgetAllocation", "EconomicPolicy"
    field?: string; // Specific field if applicable
    filter?: Record<string, any>; // Query filters for fetching related data
  };
  children?: AgendaItemTemplate[];
}

export const agendaTaxonomy: AgendaItemTemplate[] = [
  // ============================================================
  // POLICY & GOVERNANCE
  // ============================================================
  {
    id: "policy",
    label: "Policy & Governance",
    description: "Government policies, regulations, and governance matters",
    category: "governance",
    keywords: ["policy", "governance", "regulation", "law", "legislation"],
    tags: ["policy", "governance"],
    children: [
      {
        id: "policy-economic",
        label: "Economic Policy",
        description: "Fiscal policy, monetary policy, trade, and economic regulation",
        category: "economic",
        keywords: ["economic", "fiscal", "monetary", "trade", "tax", "regulation"],
        tags: ["policy", "economic"],
        relatedMetrics: ["currentTotalGdp", "adjustedGdpGrowth", "taxRevenueGDPPercent"],
        decisionType: "policy_approval",
        children: [
          {
            id: "policy-economic-taxation",
            label: "Taxation Policy",
            description: "Income tax, corporate tax, VAT, and other tax policies",
            category: "economic",
            keywords: ["tax", "taxation", "income tax", "corporate tax", "vat", "revenue"],
            tags: ["policy", "economic", "taxation"],
            relatedMetrics: ["taxRevenueGDPPercent", "taxRevenuePerCapita"],
            decisionType: "policy_approval",
            dataMapping: {
              model: "RevenueSource",
              filter: { category: "Direct Tax" }
            },
            children: [
              {
                id: "policy-economic-taxation-income",
                label: "Personal Income Tax Rates",
                description: "Review and adjust personal income tax brackets and rates",
                category: "economic",
                keywords: ["income tax", "personal tax", "tax brackets", "progressive tax"],
                tags: ["policy", "taxation", "income"],
                relatedMetrics: ["taxRevenueGDPPercent", "averageAnnualIncome"],
                decisionType: "policy_approval",
                dataMapping: {
                  model: "RevenueSource",
                  filter: { name: "Income Tax" }
                }
              },
              {
                id: "policy-economic-taxation-corporate",
                label: "Corporate Tax Policy",
                description: "Corporate tax rates, incentives, and business taxation",
                category: "economic",
                keywords: ["corporate tax", "business tax", "company tax"],
                tags: ["policy", "taxation", "corporate"],
                relatedMetrics: ["taxRevenueGDPPercent", "currentTotalGdp"],
                decisionType: "policy_approval",
                dataMapping: {
                  model: "RevenueSource",
                  filter: { name: "Corporate Tax" }
                }
              },
              {
                id: "policy-economic-taxation-vat",
                label: "Value Added Tax (VAT)",
                description: "VAT rates, exemptions, and indirect taxation",
                category: "economic",
                keywords: ["vat", "sales tax", "consumption tax", "indirect tax"],
                tags: ["policy", "taxation", "vat"],
                relatedMetrics: ["taxRevenueGDPPercent"],
                decisionType: "policy_approval",
                dataMapping: {
                  model: "RevenueSource",
                  filter: { category: "Indirect Tax" }
                }
              }
            ]
          },
          {
            id: "policy-economic-trade",
            label: "Trade & Commerce",
            description: "International trade agreements, tariffs, and commercial policy",
            category: "economic",
            keywords: ["trade", "commerce", "tariffs", "exports", "imports", "agreements"],
            tags: ["policy", "economic", "trade"],
            relatedMetrics: ["exportsGDPPercent", "importsGDPPercent"],
            decisionType: "policy_approval"
          },
          {
            id: "policy-economic-labor",
            label: "Labor & Employment Policy",
            description: "Minimum wage, labor laws, worker protections",
            category: "economic",
            keywords: ["labor", "employment", "minimum wage", "workers", "unions"],
            tags: ["policy", "economic", "labor"],
            relatedMetrics: ["minimumWage", "unemploymentRate", "laborForceParticipationRate"],
            decisionType: "policy_approval"
          }
        ]
      },
      {
        id: "policy-social",
        label: "Social Policy",
        description: "Healthcare, education, welfare, and social programs",
        category: "social",
        keywords: ["social", "healthcare", "education", "welfare", "programs"],
        tags: ["policy", "social"],
        relatedMetrics: ["lifeExpectancy", "literacyRate", "povertyRate"],
        decisionType: "policy_approval",
        children: [
          {
            id: "policy-social-healthcare",
            label: "Healthcare Policy",
            description: "Public health, healthcare funding, medical services",
            category: "social",
            keywords: ["healthcare", "health", "medical", "hospitals", "clinics"],
            tags: ["policy", "social", "healthcare"],
            relatedMetrics: ["lifeExpectancy"],
            decisionType: "policy_approval"
          },
          {
            id: "policy-social-education",
            label: "Education Policy",
            description: "Schools, universities, literacy programs, education funding",
            category: "social",
            keywords: ["education", "schools", "universities", "literacy", "learning"],
            tags: ["policy", "social", "education"],
            relatedMetrics: ["literacyRate"],
            decisionType: "policy_approval"
          },
          {
            id: "policy-social-welfare",
            label: "Social Welfare Programs",
            description: "Unemployment benefits, social safety nets, poverty reduction",
            category: "social",
            keywords: ["welfare", "benefits", "social safety", "poverty", "assistance"],
            tags: ["policy", "social", "welfare"],
            relatedMetrics: ["povertyRate", "incomeInequalityGini"],
            decisionType: "policy_approval"
          }
        ]
      },
      {
        id: "policy-infrastructure",
        label: "Infrastructure Policy",
        description: "Transportation, utilities, public works, and infrastructure development",
        category: "infrastructure",
        keywords: ["infrastructure", "transportation", "utilities", "public works", "development"],
        tags: ["policy", "infrastructure"],
        decisionType: "policy_approval",
        children: [
          {
            id: "policy-infrastructure-transport",
            label: "Transportation Infrastructure",
            description: "Roads, railways, airports, ports, and transit systems",
            category: "infrastructure",
            keywords: ["transportation", "roads", "railways", "airports", "transit"],
            tags: ["policy", "infrastructure", "transportation"],
            decisionType: "policy_approval"
          },
          {
            id: "policy-infrastructure-utilities",
            label: "Utilities & Services",
            description: "Water, electricity, telecommunications, waste management",
            category: "infrastructure",
            keywords: ["utilities", "water", "electricity", "telecom", "waste"],
            tags: ["policy", "infrastructure", "utilities"],
            decisionType: "policy_approval"
          }
        ]
      }
    ]
  },

  // ============================================================
  // BUDGET & FINANCE
  // ============================================================
  {
    id: "budget",
    label: "Budget & Finance",
    description: "Government budget allocation, financial planning, and fiscal management",
    category: "economic",
    keywords: ["budget", "finance", "allocation", "spending", "fiscal"],
    tags: ["budget", "finance"],
    relatedMetrics: ["totalGovernmentSpending", "governmentBudgetGDPPercent"],
    decisionType: "budget_allocation",
    children: [
      {
        id: "budget-annual",
        label: "Annual Budget Planning",
        description: "Overall budget planning and allocation for the fiscal year",
        category: "economic",
        keywords: ["annual budget", "fiscal year", "budget planning", "allocation"],
        tags: ["budget", "annual", "planning"],
        relatedMetrics: ["totalGovernmentSpending", "budgetDeficitSurplus"],
        decisionType: "budget_allocation",
        dataMapping: {
          model: "GovernmentStructure",
          field: "totalBudget"
        }
      },
      {
        id: "budget-departments",
        label: "Department Budget Allocation",
        description: "Budget allocation across government departments and ministries",
        category: "economic",
        keywords: ["department", "ministry", "allocation", "departmental budget"],
        tags: ["budget", "departments", "allocation"],
        decisionType: "budget_allocation",
        dataMapping: {
          model: "BudgetAllocation"
        },
        children: [
          {
            id: "budget-departments-defense",
            label: "Defense & Security Budget",
            description: "Military, national security, and defense spending",
            category: "security",
            keywords: ["defense", "military", "security", "armed forces"],
            tags: ["budget", "defense", "security"],
            decisionType: "budget_allocation",
            dataMapping: {
              model: "GovernmentDepartment",
              filter: { category: "Defense" }
            }
          },
          {
            id: "budget-departments-education",
            label: "Education Budget",
            description: "Schools, universities, and education system funding",
            category: "social",
            keywords: ["education", "schools", "universities", "learning"],
            tags: ["budget", "education"],
            relatedMetrics: ["literacyRate"],
            decisionType: "budget_allocation",
            dataMapping: {
              model: "GovernmentDepartment",
              filter: { category: "Education" }
            }
          },
          {
            id: "budget-departments-health",
            label: "Healthcare Budget",
            description: "Public health, hospitals, and medical services funding",
            category: "social",
            keywords: ["healthcare", "health", "medical", "hospitals"],
            tags: ["budget", "healthcare"],
            relatedMetrics: ["lifeExpectancy"],
            decisionType: "budget_allocation",
            dataMapping: {
              model: "GovernmentDepartment",
              filter: { category: "Health" }
            }
          },
          {
            id: "budget-departments-infrastructure",
            label: "Infrastructure Budget",
            description: "Public works, transportation, and infrastructure development",
            category: "infrastructure",
            keywords: ["infrastructure", "public works", "construction", "development"],
            tags: ["budget", "infrastructure"],
            decisionType: "budget_allocation",
            dataMapping: {
              model: "GovernmentDepartment",
              filter: { category: "Infrastructure" }
            }
          }
        ]
      },
      {
        id: "budget-revenue",
        label: "Revenue & Taxation Review",
        description: "Review tax collection, revenue sources, and fiscal sustainability",
        category: "economic",
        keywords: ["revenue", "taxation", "tax collection", "fiscal"],
        tags: ["budget", "revenue", "taxation"],
        relatedMetrics: ["taxRevenueGDPPercent", "governmentRevenueTotal"],
        decisionType: "policy_approval",
        dataMapping: {
          model: "RevenueSource"
        }
      }
    ]
  },

  // ============================================================
  // GOVERNMENT OPERATIONS
  // ============================================================
  {
    id: "operations",
    label: "Government Operations",
    description: "Day-to-day government operations, appointments, and administration",
    category: "governance",
    keywords: ["operations", "administration", "appointments", "management"],
    tags: ["operations", "governance"],
    children: [
      {
        id: "operations-appointments",
        label: "Appointments & Personnel",
        description: "Minister appointments, official assignments, and personnel matters",
        category: "governance",
        keywords: ["appointments", "personnel", "ministers", "officials", "cabinet"],
        tags: ["operations", "appointments"],
        decisionType: "appointment",
        dataMapping: {
          model: "GovernmentOfficial"
        }
      },
      {
        id: "operations-restructuring",
        label: "Government Restructuring",
        description: "Reorganization of departments, creation of new agencies",
        category: "governance",
        keywords: ["restructuring", "reorganization", "departments", "agencies"],
        tags: ["operations", "restructuring"],
        decisionType: "directive",
        dataMapping: {
          model: "GovernmentDepartment"
        }
      },
      {
        id: "operations-performance",
        label: "Performance Review",
        description: "Review of government efficiency, KPIs, and departmental performance",
        category: "governance",
        keywords: ["performance", "efficiency", "kpi", "review", "metrics"],
        tags: ["operations", "performance"],
        decisionType: "resolution"
      }
    ]
  },

  // ============================================================
  // STRATEGIC PLANNING
  // ============================================================
  {
    id: "strategic",
    label: "Strategic Planning",
    description: "Long-term planning, national priorities, and strategic initiatives",
    category: "governance",
    keywords: ["strategic", "planning", "long-term", "priorities", "vision"],
    tags: ["strategic", "planning"],
    children: [
      {
        id: "strategic-economic",
        label: "Economic Development Strategy",
        description: "Long-term economic growth, industrialization, innovation",
        category: "economic",
        keywords: ["economic development", "growth", "industrialization", "innovation"],
        tags: ["strategic", "economic"],
        relatedMetrics: ["adjustedGdpGrowth", "currentTotalGdp"],
        decisionType: "directive"
      },
      {
        id: "strategic-demographic",
        label: "Demographic Planning",
        description: "Population growth, urbanization, demographic challenges",
        category: "social",
        keywords: ["demographic", "population", "urbanization", "migration"],
        tags: ["strategic", "demographic"],
        relatedMetrics: ["populationGrowthRate", "urbanPopulationPercent"],
        decisionType: "directive"
      }
    ]
  },

  // ============================================================
  // CRISIS & EMERGENCY
  // ============================================================
  {
    id: "crisis",
    label: "Crisis & Emergency Response",
    description: "Emergency situations, crises, and urgent matters requiring immediate attention",
    category: "security",
    keywords: ["crisis", "emergency", "urgent", "disaster", "response"],
    tags: ["crisis", "emergency", "urgent"],
    decisionType: "directive",
    children: [
      {
        id: "crisis-economic",
        label: "Economic Crisis",
        description: "Financial crisis, recession, economic emergency measures",
        category: "economic",
        keywords: ["economic crisis", "recession", "financial crisis", "emergency"],
        tags: ["crisis", "economic", "urgent"],
        decisionType: "directive"
      },
      {
        id: "crisis-security",
        label: "Security Emergency",
        description: "National security threats, defense emergencies",
        category: "security",
        keywords: ["security", "defense", "threat", "emergency"],
        tags: ["crisis", "security", "urgent"],
        decisionType: "directive"
      },
      {
        id: "crisis-natural",
        label: "Natural Disaster Response",
        description: "Natural disasters, emergency relief, disaster management",
        category: "social",
        keywords: ["disaster", "natural disaster", "relief", "emergency"],
        tags: ["crisis", "disaster", "urgent"],
        decisionType: "directive"
      }
    ]
  },

  // ============================================================
  // DIPLOMATIC & INTERNATIONAL
  // ============================================================
  {
    id: "diplomatic",
    label: "Diplomatic & International Affairs",
    description: "Foreign relations, international agreements, and diplomatic matters",
    category: "diplomatic",
    keywords: ["diplomatic", "international", "foreign", "relations", "treaties"],
    tags: ["diplomatic", "international"],
    children: [
      {
        id: "diplomatic-treaties",
        label: "International Treaties & Agreements",
        description: "Trade agreements, alliances, international cooperation",
        category: "diplomatic",
        keywords: ["treaties", "agreements", "alliances", "cooperation"],
        tags: ["diplomatic", "treaties"],
        decisionType: "resolution"
      },
      {
        id: "diplomatic-relations",
        label: "Bilateral Relations",
        description: "Relations with specific countries, diplomatic missions",
        category: "diplomatic",
        keywords: ["bilateral", "relations", "embassy", "diplomatic"],
        tags: ["diplomatic", "bilateral"],
        decisionType: "resolution"
      }
    ]
  }
];

/**
 * Flatten the taxonomy for search/filtering
 */
export function flattenTaxonomy(items: AgendaItemTemplate[] = agendaTaxonomy, depth = 0): AgendaItemTemplate[] {
  const result: AgendaItemTemplate[] = [];

  for (const item of items) {
    result.push({ ...item, children: undefined }); // Add without children for flat list
    if (item.children) {
      result.push(...flattenTaxonomy(item.children, depth + 1));
    }
  }

  return result;
}

/**
 * Search taxonomy by keyword
 */
export function searchAgendaItems(query: string, items: AgendaItemTemplate[] = agendaTaxonomy): AgendaItemTemplate[] {
  const lowerQuery = query.toLowerCase().trim();
  if (!lowerQuery) return [];

  const flatItems = flattenTaxonomy(items);
  return flatItems.filter(item =>
    item.label.toLowerCase().includes(lowerQuery) ||
    item.description.toLowerCase().includes(lowerQuery) ||
    item.keywords.some(kw => kw.toLowerCase().includes(lowerQuery)) ||
    item.tags.some(tag => tag.toLowerCase().includes(lowerQuery))
  );
}

/**
 * Get item by ID
 */
export function getAgendaItemById(id: string, items: AgendaItemTemplate[] = agendaTaxonomy): AgendaItemTemplate | null {
  for (const item of items) {
    if (item.id === id) return item;
    if (item.children) {
      const found = getAgendaItemById(id, item.children);
      if (found) return found;
    }
  }
  return null;
}

/**
 * Get breadcrumb path for an item
 */
export function getAgendaItemPath(id: string, items: AgendaItemTemplate[] = agendaTaxonomy, path: AgendaItemTemplate[] = []): AgendaItemTemplate[] | null {
  for (const item of items) {
    const currentPath = [...path, item];
    if (item.id === id) return currentPath;
    if (item.children) {
      const found = getAgendaItemPath(id, item.children, currentPath);
      if (found) return found;
    }
  }
  return null;
}
